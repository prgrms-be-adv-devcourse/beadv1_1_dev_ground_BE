apiVersion: batch/v1
kind: CronJob
metadata:
  name: ssl-cert-renew
spec:
  # 매월 1일 새벽 3시에 실행 (Let's Encrypt는 90일 유효)
  schedule: "0 3 1 * *"

  jobTemplate:
    spec:
      template:
        spec:
          hostNetwork: true
          restartPolicy: OnFailure

          volumes:
            - name: letsencrypt
              hostPath:
                path: /etc/letsencrypt
                type: Directory
            - name: kubeconfig
              hostPath:
                path: /etc/rancher/k3s
                type: Directory

          containers:
            - name: certbot-renew
              image: certbot/certbot:latest
              command:
                - /bin/sh
                - -c
                - |
                  # 인증서 갱신
                  certbot renew --standalone --pre-hook "kubectl scale deployment nginx-proxy-manager --replicas=0" --post-hook "kubectl scale deployment nginx-proxy-manager --replicas=1"

                  # k8s Secret 업데이트
                  kubectl create secret tls dbay-tls-secret \
                    --cert=/etc/letsencrypt/live/dbay.site/fullchain.pem \
                    --key=/etc/letsencrypt/live/dbay.site/privkey.pem \
                    --dry-run=client -o yaml | kubectl apply -f -

                  # nginx 재시작하여 새 인증서 적용
                  kubectl rollout restart deployment nginx-proxy-manager

              volumeMounts:
                - name: letsencrypt
                  mountPath: /etc/letsencrypt
                - name: kubeconfig
                  mountPath: /etc/rancher/k3s

              env:
                - name: KUBECONFIG
                  value: /etc/rancher/k3s/k3s.yaml